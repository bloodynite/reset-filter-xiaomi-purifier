<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reset Filter Xiaomi Purifier - Command Generator</title>
  <style>
    :root{
      --primary:#4361ee; --primary-dark:#3a56d4; --light:#f8f9fa; --dark:#212529; --gray:#6c757d; --br:8px; --shadow:0 6px 18px rgba(17,24,39,0.08);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif}
    body{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;background:linear-gradient(135deg,#f5f7fa 0%,#e6eef9 100%);color:var(--dark)}
    .card{width:100%;max-width:760px;background:#fff;border-radius:var(--br);box-shadow:var(--shadow);overflow:hidden}
    header{padding:20px 24px;background:linear-gradient(90deg,var(--primary),#7209b7);color:#fff}
    header h1{font-size:20px;margin-bottom:6px}
    header p{opacity:.9;font-size:13px}
    .body{padding:20px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1;min-width:220px}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type=text]{width:100%;padding:10px 12px;border:1px solid #e6e9ef;border-radius:10px;font-family:monospace;font-size:14px}
    .hint{font-size:12px;color:var(--gray);margin-top:6px}
    .controls{margin-top:14px}
    button.btn{background:var(--primary);color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    button.secondary{background:#eef2ff;color:var(--primary);border:1px solid rgba(67,97,238,.12)}
    .result{margin-top:18px}
    .code{background:#0f1724;color:#e6eef8;padding:14px;border-radius:10px;font-family:Consolas,Menlo,monospace;position:relative;white-space:pre-wrap}
    .copy{position:absolute;right:12px;top:12px;padding:6px 8px;border-radius:6px;background:rgba(255,255,255,0.08);color:#fff;border:none;cursor:pointer}
    .debug{margin-top:12px;background:#fbfdff;border-left:4px solid var(--primary);padding:12px;border-radius:8px}
    .debug p{font-size:13px;margin:6px 0;color:#1f2937}
    footer{padding:14px 20px;border-top:1px solid #f0f2f6;background:#fff}
    @media (max-width:520px){.row{flex-direction:column}}
  </style>
</head>
<body>
  <div class="card" role="main">
    <header>
      <h1>Reset Filter Xiaomi Purifier</h1>
      <p>Models: 3H, Pro, 4 Pro, Mi Pro H, etc.</p>
    </header>

    <div class="body">
      <div class="row">
        <div class="col">
          <label for="uuid">Serial</label>
          <input id="uuid" type="text" inputmode="latin" placeholder="Example: 53:38:6C:F3:71:00:01" autocomplete="off" />
        </div>
        <div class="col" style="max-width:220px">
          <label>&nbsp;</label>
          <div class="controls">
            <button id="gen" class="btn">Generate</button>
            <button id="reset" class="secondary" style="margin-left:8px">Reset</button>
          </div>
        </div>
      </div>

      <div class="result" id="resultArea" style="display:none">
        <h3 style="margin-bottom:8px">Generated Command</h3>
        <div class="code" id="codeBlock"><button class="copy" id="copyBtn">Copy</button><code id="cmdText"></code></div>

        <div class="debug" id="debug" style="display:none">
          <strong>Debug info</strong>
          <p><strong>Clean UUID:</strong> <span id="d_uuid"></span></p>
          <p><strong>SHA-1:</strong> <span id="d_hash"></span></p>
          <p><strong>First byte hex/dec:</strong> <span id="d_first"></span></p>
          <p><strong>Indices:</strong> <span id="d_idx"></span></p>
          <p><strong>Extracted bytes:</strong> <span id="d_bytes"></span></p>
        </div>
      </div>

    </div>

    <footer>
      <small style="color:var(--gray)">Reset Filter Xiaomi Purifier</small>
    </footer>
  </div>

<script>
// Utility: keep caret near where user expects while formatting
function formatHex(value) {
  const raw = value.replace(/[^0-9a-fA-F]/g, "");
  let formatted = "";
  for (let i = 0; i < raw.length; i++) {
    formatted += raw[i].toUpperCase();
    if (i % 2 === 1 && i < raw.length - 1) formatted += ":";
  }
  return formatted;
}

const input = document.getElementById('uuid');
let lastSelectionStart = 0;
input.addEventListener('keydown', (e)=>{
  // remember selection start to try to restore caret after formatting
  lastSelectionStart = input.selectionStart;
});

input.addEventListener("input", () => {
  const pos = input.selectionStart;
  const rawBefore = input.value.replace(/[^0-9a-fA-F]/g, "");
  const formatted = formatHex(rawBefore);
  input.value = formatted;
  input.setSelectionRange(formatted.length, formatted.length);
});

// Allow paste of various formats
input.addEventListener("paste", (e) => {
  e.preventDefault();
  const txt = (e.clipboardData || window.clipboardData).getData("text");
  input.value = formatHex(txt);
});

// Reset button
document.getElementById('reset').addEventListener('click', ()=>{
  input.value = '';
  hideResult();
});

// Main generate flow (no hard validations)
document.getElementById('gen').addEventListener('click', ()=>{
  const raw = input.value.replace(/[^0-9a-fA-F]/g,'');
  if(!raw){
    showError('Please enter at least one hex byte of the device serial.');
    return;
  }
  try{
    const uidBytes = hexStringToByteArray(raw);
    // compute sha1
    const hashHex = sha1(uidBytes);
    // compute first byte decimal
    const firstByteHex = hashHex.substring(0,2);
    const firstByteDec = parseInt(firstByteHex,16);
    // indices formula (same as original)
    const indices = [firstByteDec % 20, (firstByteDec+5)%20, (firstByteDec+13)%20, (firstByteDec+17)%20];
    // split hash into bytes
    const hashBytes = hashHex.match(/.{1,2}/g) || [];
    const extracted = indices.map(i => (hashBytes[i]||'00'));
    const base = '1B' + extracted.join('') + ',3008';
    const command = base + ',A20800000000';

    // show
    document.getElementById('cmdText').textContent = command;
    document.getElementById('resultArea').style.display = 'block';
    const dbg = document.getElementById('debug'); dbg.style.display = 'block';
    document.getElementById('d_uuid').textContent = raw.toUpperCase();
    document.getElementById('d_hash').textContent = hashHex;
    document.getElementById('d_first').textContent = `${firstByteHex.toUpperCase()} (${firstByteDec})`;
    document.getElementById('d_idx').textContent = indices.join(', ');
    document.getElementById('d_bytes').textContent = extracted.join(' ');

  }catch(err){
    showError('Error generating command: ' + (err.message||err));
  }
});

function showError(msg){
  // simple inline error via alert area (reuse result area to show message)
  alert(msg);
}
function hideResult(){document.getElementById('resultArea').style.display='none';}

// copy
document.getElementById('copyBtn').addEventListener('click', async ()=>{
  const txt = document.getElementById('cmdText').textContent || '';
  try{
    await navigator.clipboard.writeText(txt);
    const btn = document.getElementById('copyBtn');
    const old = btn.textContent;
    btn.textContent = 'Copied!';
    setTimeout(()=>btn.textContent = old,1500);
  }catch(e){ alert('Copy failed'); }
});

// Helpers
function hexStringToByteArray(hex){
  const cleaned = hex.replace(/[^0-9a-fA-F]/g,'');
  const arr = new Uint8Array(Math.ceil(cleaned.length/2));
  for(let i=0;i<cleaned.length;i+=2){ arr[i/2] = parseInt(cleaned.substr(i,2) || '0',16); }
  return arr;
}

// SHA-1 implementation (works on Uint8Array) - compatible with Python SHA-1
function sha1(message){
  // convert to byte array if needed
  let msg = message instanceof Uint8Array ? message : new Uint8Array(message);
  const ml = msg.length * 8;
  // padding
  const withOne = new Uint8Array(msg.length + 1);
  withOne.set(msg); withOne[msg.length] = 0x80;
  // compute padded length (multiple of 64 bytes with 8 bytes for length)
  let padLen = (64 - ((withOne.length + 8) % 64)) % 64;
  const padded = new Uint8Array(withOne.length + padLen + 8);
  padded.set(withOne);
  // append length in bits big-endian
  const dv = new DataView(padded.buffer);
  dv.setUint32(padded.length - 8, Math.floor(ml / (2**32)), false); // high
  dv.setUint32(padded.length - 4, ml >>> 0, false); // low

  let h0=0x67452301, h1=0xEFCDAB89, h2=0x98BADCFE, h3=0x10325476, h4=0xC3D2E1F0;

  function rotl(x,n){ return (x<<n) | (x>>> (32-n)); }

  for(let i=0;i<padded.length;i+=64){
    const w = new Uint32Array(80);
    for(let j=0;j<16;j++) w[j] = dv.getUint32(i + j*4, false);
    for(let j=16;j<80;j++) w[j] = rotl(w[j-3]^w[j-8]^w[j-14]^w[j-16],1) >>> 0;

    let a=h0,b=h1,c=h2,d=h3,e=h4;
    for(let t=0;t<80;t++){
      let f,k;
      if(t<20){ f=(b & c) | ((~b) & d); k=0x5A827999; }
      else if(t<40){ f = b ^ c ^ d; k=0x6ED9EBA1; }
      else if(t<60){ f = (b & c) | (b & d) | (c & d); k=0x8F1BBCDC; }
      else { f = b ^ c ^ d; k=0xCA62C1D6; }
      const temp = ( (rotl(a,5)>>>0) + (f>>>0) + (e>>>0) + (k>>>0) + (w[t]>>>0) ) >>> 0;
      e=d; d=c; c = rotl(b,30) >>> 0; b=a; a=temp;
    }
    h0 = (h0 + a) >>> 0; h1 = (h1 + b) >>> 0; h2 = (h2 + c) >>> 0; h3 = (h3 + d) >>> 0; h4 = (h4 + e) >>> 0;
  }
  const out = [h0,h1,h2,h3,h4].map(h => ('00000000' + (h>>>0).toString(16)).slice(-8)).join('');
  return out;
}
</script>
</body>
</html>
